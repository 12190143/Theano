\documentclass[utf8x,xcolor=pdftex,dvipsnames,table]{beamer}
\usetheme{Malmoe}  % Now it's a beamer presentation with the lisa theme!
\setbeamertemplate{footline}[page number]
\usecolortheme{beaver}
\usepackage[T1]{fontenc}
\usepackage{amsmath}
\usepackage[utf8x]{inputenc}
%\logo{\includegraphics[width=.8in]{UdeM_NoirBleu_logo_Marie_crop}}
\usepackage{listings}

\newcommand{\superscript}[1]{\ensuremath{^{\textrm{#1}}}}

\mode<presentation>

\title{Theano, Pylearn2, libgpuarray Presentation}

\author{%
\footnotesize
Frédéric Bastien\superscript{a}, Bart van Merriënboer\superscript{a} \newline
\superscript{a}Département d'Informatique et de Recherche Opérationnelle \newline
Université de Montréal \newline
Montréal, Canada \newline
\texttt{\{bastienf, vanmerb\}@iro.umontreal.ca} \newline \newline
}

\date{OML Workshop 2014}

\setbeamertemplate{navigation symbols}{}

\begin{document}

\begin{frame}[plain]
 \titlepage
 \vspace{-5em}
 \includegraphics[width=1in]{../hpcs2011_tutorial/pics/lisabook_logo_text_3.png}
 \hfill
 \includegraphics[width=.8in]{../hpcs2011_tutorial/pics/UdeM_NoirBleu_logo_Marie_crop}
\end{frame}

\section{Introduction}
\begin{frame}{High level}\setcounter{page}{1}
  Python <- \{NumPy/SciPy/libgpuarray\} <- Theano <- Pylearn2
  \begin{itemize}
  \item Python: OO coding language
  \item Numpy: n-dimension array object and scientific computing toolbox
  \item SciPy: sparse matrix object and more scientific computing functionality
  \item libgpuarray: gpu n-dimentional array object in C for CUDA and OpenCL
  \item Theano: compiler/symbolic graph manipulation
  \item Pylearn2: machine learning framework
  \end{itemize}
\end{frame}

\begin{frame}{Python}
  \begin{itemize}
  \item General-purpose high-level OO interpreted language
  \item Emphasizes code readability
  \item Comprehensive standard library
  \item Dynamic type and memory management
  \item Slow execution
  \item Easily extensible from C
  \item Popular in *web-dev* and *scientific communities*
  \end{itemize}
\end{frame}

\begin{frame}{NumPy/SciPy}
  \begin{itemize}
  \item Python floats are full-fledged objects on the heap
      \begin{itemize}
      \item Not suitable for high-performance computing!
      \end{itemize}

  \item NumPy provides a N-dimensional numeric array in Python
      \begin{itemize}
      \item Perfect for high-performance computing.
      \item Slices of arrays are views (no copy)
      \end{itemize}

  \item NumPy provides
      \begin{itemize}
      \item Elementwise computations
      \item Linear algebra, Fourier transforms
      \item Pseudorandom numbers from many distributions
      \end{itemize}

  \item SciPy provides lots more, including
      \begin{itemize}
      \item Sparse matrix
      \item More linear algebra
      \item Solvers and optimization algorithms
      \item Matlab-compatible I/O
      \item I/O and signal processing for images and audio
      \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}{What's missing?}
  \begin{itemize}
    \item Non-lazy evaluation (required by Python) hurts performance
    \item Bound to the CPU
    \item Lacks symbolic or automatic differentiation
    \item No automatic speed and stability optimization
  \end{itemize}

\end{frame}

\begin{frame}{Why scripting for GPUs?}
  \begin{bf}They Complement each other\end{bf}

  GPUs are everything that scripting/high level languages are not

  \begin{itemize}
    \item Highly parallel
    \item Very architecture-sensitive
    \item Built for maximum FP/memory throughput
    \item So hard to program that meta-programming is easier.
  \end{itemize}

  \begin{bf}Best of both:\end{bf} easy scripted development invokes GPU kernel.

  \begin{bf}Theano C code generation removes overhead\end{bf} from
  function call between Python and C, by launching many C functions at once.

\end{frame}

\begin{frame}{Theano}

  High-level domain-specific language tailored to numeric computation.

  \begin{itemize}
    \item Syntax as close to NumPy as possible
    \item Compiles most common expressions to C for CPU and GPU
    \item Limited expressivity means more opportunities optimizations
    \begin{itemize}
      \item No subroutines -> global optimization
      \item Strongly typed -> compiles to machine instructions
      \item Array oriented -> easy parallelism
      \item Support for looping and branching in expressions
    \end{itemize}
    \item Automatic speed and stability optimizations
    \item Can reuse other technologies for best performance.
    \begin{itemize}
      \item BLAS, SciPy, Cython, Numba, PyCUDA, CUDA
    \end{itemize}
    \item Automatic differentiation and R op
    \item Sparse matrices
  \end{itemize}
\end{frame}


\begin{frame}{Pylearn2}

  Machine Learning library aimed at researchers

  \begin{itemize}
    \item Built on top of Theano, for fast execution and use of GPU
    \item Easy to try variants of implemented algorithms, and to extend them (using Theano)
    \item Contains a collection of:
    \begin{itemize}
      \item Training Algorithms (i.e., Stochastic and Batch GD, model-specific rules)
      \item Costs and Estimation Criteria, supervised and unsupervised (NLL, Score Matching, NCE)
      \item Models (NNets, ConvNets, RBMs, k-means, PCA, SVMs)
      \item Datasets (MNIST, CIFAR-10) and preprocessors (LCN, ZCA)
    \end{itemize}
    \item Experiments can be specified through a YAML config file, or by a Python script
    \item Scripts for visualizing weights, plot monitored values
  \end{itemize}
\end{frame}


\begin{frame}{Goal of the stack}
You can't have your cake and eat it too.\newline
We want our cake and eat it too.???\newline
Target the holy grail: \begin{bf}fast to develop\end{bf} and \begin{bf}fast to run\end{bf}.
\end{frame}


\begin{frame}{libgpuarray}
  GOAL: A common GPU n dimensions array that can be reused by all projects. It support CUDA and OpenCL.
  \newline \newline
  Motivation:
  \begin{itemize}
  \item Currently there are at least 6 different gpu arrays in python
    \begin{itemize}
    \item CudaNdarray(Theano), GPUArray(pycuda), CUDAMatrix(cudamat), GPUArray(pyopencl), Clyther, Copperhead, ...
    \item There are even more if we include other languages.
    \end{itemize}
  \item They are incompatible
    \begin{itemize}
    \item None have the same properties and interface.
    \end{itemize}
  \item All of them are a subset of numpy.ndarray on the gpu!
  \end{itemize}
\end{frame}


\section{Theano}
\begin{frame}{Description}
  \begin{itemize}
    \item Mathematical symbolic expression compiler
    \item Expressions mimic NumPy's syntax and semantics (easier to use)
    \item Dynamic C/CUDA code generation
    \begin{itemize}
      \item Is used with other technologie to generate fast code: C/C++, CUDA, OpenCL, PyCUDA, Cython, Numba, \ldots
    \end{itemize}
    \item Efficient symbolic differeniation
    \begin{itemize}
      \item Theano computes derivatives of functions with one or many inputs.
      \item Also support computation of the Jacobian, Hessian, R and L op.
    \end{itemize}
    \item Speed and stability optimizations
    \begin{itemize}
      \item Gives the right answer for ``log(1+x)'' even if x is really tiny.
    \end{itemize}
    \item Works on Linux, Mac and Windows
    \item Transparent use of a GPU
    \begin{itemize}
      \item {\tt float32} only for now (working on other data types)
      \item Still in experimental state on Windows
    \end{itemize}

    \item Extensive unit-testing and self-verification
    \begin{itemize}
      \item Detects and diagnoses many types of errors
    \end{itemize}

%    \item Statically typed and purely functional
    \item Sparse operations (CPU only)
  \end{itemize}
\end{frame}

% The following does not work with lstset, for some reason
%\begin{frame}{Simple example}
\begin{frame}[fragile]
  \frametitle{Simple example}

\lstset{language=Python,
        commentstyle=\itshape\color{blue}
        }
\begin{lstlisting}
import theano
# declare symbolic variable
a = theano.tensor.vector("a")
# build symbolic expression
b = a + a ** 10
# compile function
f = theano.function([a], b)
print f([0, 1, 2])
# prints `array([0, 2, 1026])`
\end{lstlisting}
\end{frame}

\begin{frame}{Simple example: graph optimization}
\center
\includegraphics[width=0.35\textwidth]{../hpcs2011_tutorial/pics/f_unoptimized.png}
\hspace{0.1\textwidth}
\includegraphics[width=0.35\textwidth]{../hpcs2011_tutorial/pics/f_optimized.png}
%Symbolic programming = *Paradigm shift*: people need to use it to understand it.

\end{frame}


\begin{frame}{Project status?}
  \begin{itemize}
    \item Mature: Theano has been developed and used since January 2008 (6.5 yrs old)
    \item Driven over 100 research papers
    \item Good user documentation
    \item Active mailing list with participants from outside our lab
    \item Core technology for a few Silicon-Valley start-ups
    \item Many contributors (some from outside our lab)
    \item Used to teach many university classes
    \item Has been used for research at Google and Yahoo.
  \end{itemize}
  Theano: \url{deeplearning.net/software/theano/}

  Deep Learning Tutorials: \url{deeplearning.net/tutorial/}
\end{frame}


\section{Pylearn2}
\begin{frame}{Pylearn2 details}
\end{frame}
\begin{frame}{Project status?}
\end{frame}

\section{libgpuarray}
\begin{frame}{libgpuarray: Design Goals}
  \begin{itemize}
  \item Have the base object in C to allow collaboration with more projects.
    \begin{itemize}
    \item We want people from C, C++, ruby, R, ... all use the same base GPU ndarray.
    \end{itemize}
  \item Be compatible with CUDA and OpenCL.
  \item Not too simple, (don’t support just matrix).
  \item But still easy to develop new code that support only a few memory layout.
    \begin{itemize}
    \item This ease the development of new code.
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}{Project status?}
  \begin{itemize}
  \item Usable directly, but not all implementation available.
  \item Multiple GPU work.
  \item Is the next GPU array container for Theano and is working.
    \begin{itemize}
    \item Not all Theano implementation available now.
    \item OpenCL miss more implementation.
    \item Multiple GPU on the way.
    \end{itemize}
  \item Web site: \url{http://deeplearning.net/software/libgpuarray/}
  \end{itemize}
\end{frame}

\section{sharing}
\begin{frame}{How can we do it?}

  \only<1>{License: Suggest BSD as it is used by many software in our field.}
  \only<1>{Common license help share code.}
  \only<1>{Don't forget to copy the copyright notice when you copy code.}
  \only<2>{Common base object! \begin{bf}libgpuarray\end{bf}}
  \only<3>{Otherwise: put important implementation(e.g convolution) in separate file and use raw ptr/shape/strides as inputs? Doc that interface.}
  \only<4>{acknowled reuse \begin{bf}in section on web site\end{bf} AND \begin{bf}in paper\end{bf} about the software we reuse! (and use too)}

\end{frame}

\begin{frame}{OLD STUFF Why do we need this?}
\begin{itemize}
\item Efficient linear algebra is a the core of many scientific applications
\item On the CPU, numpy ndarray provides a standard object (for python at least)
\end{itemize}
\end{frame}

\begin{frame}{Why a new implementation?}
\begin{block}{There are already a number of existing GPU computing codebases:}
Theano, PyCUDA/PyOpenCL, CUDAmat, Gnumpy, Thrust, \ldots
\end {block}
\begin{enumerate}
\item<2-> All are incompatible, which hinders code sharing.
\item<3-> They do not support the full range of numpy ndarray features
\item<4-> None support both CUDA and OpenCL
\end{enumerate}
\end{frame}

\section{Features}

\begin{frame}{Strides}
\only<1>{Strides is a way to specify how much memory to skip between each element of a dimension.}
\only<2>{We can use strides to take submatrix ${\color{cyan!50}B}$ without copying any memory.}
\begin{center}
\onslide<1->{Matrix ${\color{red!50}A}$}\hspace{5em}\onslide<2->{Matrix ${\color{cyan!50}B}$}
\end{center}
\begin{center}
%%\only<1>{\includegraphics{strides-1}}
%%\only<2>{\includegraphics{strides-2}}
\end{center}
\end{frame}

\begin{frame}{Features desired}
\begin{itemize}
\item {\color{gray!80} Support for varying datatypes}
\item {\color{gray!80} Support for an arbitrary number of dimensions}
\item {\color{gray!80} Support for strides}
\item Support for broadcasting
\item {\color{gray!80} Compatibility with CUDA and OpenCL}
\end{itemize}
\end{frame}

\begin{frame}{Comparison of existing implementations}
\begin{table}
\rowcolors{2}{RoyalBlue!5}{RoyalBlue!23}
\begin{tabular}{|l|c|c|c|c|c|}
\hline
Package & strides & bcast & dims & types & backends \\
\hline
\hline
Theano & yes\footnote{as number of elements} & yes & any & float32 & CUDA \\
PyCUDA& no & no & any & all & CUDA \\
PyOpenCL & no & no & any & all & OpenCL \\
CUDAMat & no & yes\footnote{via a function} & 2 & float32 & CUDA \\
Gnumpy & no & yes & any & float32\footnote{and a hackish form of boolean} & CUDA \\
Thrust & no & no & 1 & all & CUDA \\
\hline
\hiderowcolors
Desired & yes & yes & any & all & both \\
\hline
\end{tabular}
\end{table}
\end{frame}


%%\vspace{-1em}

\section{Conclusion}
\begin{frame}{Future plans}
\begin{itemize}
\item<1-> Use in Theano/PyOpenCL/PyCUDA
\item<2-> Design and implement a good C/C++ interface
\item<3-> Find ways to lower the overhead
\item<4-> Use the implicit looping provided by CUDA and OpenCL
\item<5-> World domination!
\begin{itemize}
\item<6-> Library authors $\to$ come see us
\item<6-> Supervisers $\to$ talk to your students about this project
\end{itemize}
\end{itemize}
\end{frame}

\begin{frame}{Acknowledgment}
\begin{itemize}
\item James Bergstra
\item Compute Canada, RQCHP, NSERC, and Canada Research Chairs for providing funds or access to compute resources.
\end{itemize}
\end{frame}

\begin{frame}
\begin{center}
\Huge
Questions?
\end{center}
\end{frame}


\end{document}
